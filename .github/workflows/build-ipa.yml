name: Build IPA

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      export_method:
        description: Export method for IPA signing
        required: true
        default: ad-hoc
        type: choice
        options:
          - ad-hoc
          - development

jobs:
  build-ipa:
    runs-on: macos-14
    env:
      PROJECT_SPEC: project.yml
      PROJECT_NAME: vertd
      PROJECT_PATH: vertd.xcodeproj
      SCHEME: vertd
      CONFIGURATION: Release
      ARCHIVE_PATH: ${{ github.workspace }}/build/vertd.xcarchive
      EXPORT_PATH: ${{ github.workspace }}/build/export
      EXPORT_METHOD: ${{ inputs.export_method || 'ad-hoc' }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_BUNDLE_ID: ${{ secrets.IOS_BUNDLE_ID }}
      IOS_SIGNING_CERT: ${{ secrets.IOS_SIGNING_CERT }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: |
          if ! command -v xcodegen >/dev/null 2>&1; then
            brew update
            brew install xcodegen
          fi

      - name: Generate Xcode project
        run: |
          rm -rf "$PROJECT_PATH"
          xcodegen generate --spec "$PROJECT_SPEC" --project "$PROJECT_NAME"

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          p12-password: ${{ secrets.IOS_CERT_PASSWORD }}

      - name: Install provisioning profile
        id: provisioning
        run: |
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
          security cms -D -i profile.mobileprovision > profile.plist

          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' profile.plist)
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' profile.plist)

          cp profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

          echo "profile_name=$PROFILE_NAME" >> "$GITHUB_OUTPUT"
          echo "profile_uuid=$PROFILE_UUID" >> "$GITHUB_OUTPUT"

      - name: Validate signing secrets
        run: |
          if [ -z "$IOS_TEAM_ID" ]; then
            echo "::error::Missing IOS_TEAM_ID secret."
            exit 1
          fi
          if [ -z "$IOS_SIGNING_CERT" ]; then
            echo "::error::Missing IOS_SIGNING_CERT secret (example: Apple Distribution)."
            exit 1
          fi

      - name: Create ExportOptions.plist
        run: |
          cat > ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${EXPORT_METHOD}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${IOS_BUNDLE_ID}</key>
              <string>${{ steps.provisioning.outputs.profile_name }}</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

      - name: Build archive
        run: |
          xcodebuild \
            -project "$PROJECT_PATH" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -destination 'generic/platform=iOS' \
            -archivePath "$ARCHIVE_PATH" \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$IOS_BUNDLE_ID" \
            CODE_SIGN_IDENTITY="$IOS_SIGNING_CERT" \
            PROVISIONING_PROFILE_SPECIFIER="${{ steps.provisioning.outputs.profile_name }}" \
            clean archive

      - name: Export IPA
        run: |
          mkdir -p "$EXPORT_PATH"
          xcodebuild \
            -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportPath "$EXPORT_PATH" \
            -exportOptionsPlist ExportOptions.plist

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: vertd-ipa-${{ github.run_number }}
          path: |
            build/export/*.ipa
            build/export/*.dSYM
          if-no-files-found: error
